<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grand CafÃ© Concierge - Debug</title>
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"></script>
    <style>
        body { background-color: #FEF9EE; font-family: sans-serif; padding: 20px; color: #5a5a5a; }
        #status-box { 
            background: white; border: 2px solid #978550; 
            padding: 15px; margin-bottom: 20px; border-radius: 8px;
        }
        .log-entry { margin: 5px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        button {
            padding: 10px 20px; background: #978550; color: white; 
            border: none; font-size: 16px; cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Debug Console</h2>
    <div id="status-box">Waiting to start...</div>
    <button onclick="startChat()">ðŸš€ Force Start Chat</button>

    <script>
        const TOKEN_URL = "/api/token"; 
        const consoleBox = document.getElementById('status-box');

        function log(msg, type="neutral") {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `> ${msg}`;
            consoleBox.appendChild(div);
        }

        async function startChat() {
            consoleBox.innerHTML = ""; // Clear
            log("Starting initialization...");

            try {
                // CHECK 1: Library
                if (customElements.get('openai-chatkit')) {
                    log("Library already loaded.", "success");
                } else {
                    log("Waiting for ChatKit library...");
                    await customElements.whenDefined('openai-chatkit');
                    log("Library loaded successfully.", "success");
                }

                // CHECK 2: Token
                log("Fetching Secret Token...");
                const res = await fetch(TOKEN_URL, { method: 'POST' });
                log(`API HTTP Status: ${res.status}`);
                
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`API Failed: ${text}`);
                }

                const data = await res.json();
                if (!data.client_secret) throw new Error("Token missing from response!");
                log("Token received successfully.", "success");

                // CHECK 3: Render
                log("Injecting Chat Window...");
                const chat = document.createElement('openai-chatkit');
                
                chat.setOptions({
                    api: {
                        getClientSecret: async () => {
                            log("ChatKit requested token. Providing it...", "success");
                            return data.client_secret;
                        }
                    },
                    theme: 'light',
                    header: { title: 'Concierge Debug' }
                });

                document.body.appendChild(chat);
                log("Chat appended to body. Check bottom of screen.", "success");

            } catch (err) {
                log(`CRITICAL ERROR: ${err.message}`, "error");
            }
        }
        
        // Auto-start
        window.addEventListener('load', startChat);
    </script>
</body>
</html>
